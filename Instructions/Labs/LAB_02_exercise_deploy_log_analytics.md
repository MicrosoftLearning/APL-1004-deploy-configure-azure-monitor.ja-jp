---
lab:
  title: 演習 - Log Analytics をデプロイする
  module: Guided Project - Deploy and configure Azure Monitor
---
この演習では、Azure Monitor のログ分析を構成します。

この演習の所要時間は約 **10** 分です。 <!-- update with estimated duration -->

## スキルアップ タスク

- Log Analytics ワークスペースを作成する
- Log Analytics のデータ保持とアーカイブのポリシーを構成します。
- Log Analytics ワークスペースへのアクセスを有効にします。

## 演習の手順

### Log Analytics ワークスペースを作成する

1. Azure portal の検索バーに「**Log analytics**」と入力し、結果から **[Log Analytics ワークスペース]** を選択します。
2. **[Log Analytics ワークスペース]** ページで、**[作成]** を選択します。
3. Log Analytics ワークスペース ウイザードの **[基本]** ページで、次の情報を入力し、**[確認と作成]** を選択します。
   
    | プロパティ        | 値           |
    |:---------------|:----------------|
    | サブスクリプション   | 該当するサブスクリプション|
    | リソース グループ | rg-alpha         |
    | Name           | LogAnalytics1    |
    | リージョン         | 米国東部          |

4. **[確認および作成]** を選択します。
5. 情報を確認し、**[作成]** を選択します。

### データ収集ルールを使用して Linux-VM に Azure Monitor エージェントをインストールして構成する

1. Azure portal で、検索バーに「**データ収集ルール**」と入力し、結果から **[データ収集ルール]** を選択します。
2. **[+ 作成]** を選択して、新しいデータ収集ルールを開始します。
3. **[基本]** ページで、以下を設定します。
    - **ルール名: **DCR-Linux-VM
    - **[サブスクリプション]**: 自分のサブスクリプション
    - **リソース グループ: ** rg-alpha
    - **リージョン: **米国東部 (お使いの VM/ワークスペースに一致するリージョンを選択します)
    - **プラットフォームの種類: **Linux を選択します
    - **[次へ: リソース >]** を選択します
4. **[リソース]** で、**[+ リソースの追加]** を選択します。
    - **[Linux-VM]** を検索して選択します。
    - **適用**を選択します。
    - **[次へ: 収集と配信 >]** を選択します
5. **[収集と配信]** タブで、次の手順を実行します。
    - **[+ データ ソースの追加]** を選択します。
    - **[データ ソースの種類]** で **[パフォーマンス カウンター]** を選択します。
    - **[次へ: 宛先 >]** を選択します。
    - **[+ 宛先の追加]** を選択します。
    - **[宛先の種類]** で **[Azure Monitor ログ]** を選択します。
    - **[宛先の詳細]** で、**[LogAnalytics1 (rg-alpha)]** を選択します。
    - **[データ ソースの追加]** を選択します。
    - **[Next: Review + create]\(次へ: 確認と作成\)** を選択します。
6. **[確認と作成]** ページで選択内容を確認し、**[作成]** を選択して DCR をデプロイします。

> **注:**  DCR を VM に割り当てると、Azure Monitor エージェント拡張機能が VM に自動的にデプロイされます。 拡張機能ブレードでエージェントを手動で追加する必要は**ありません**。

7. **エージェントのインストールとデータ インジェストを確認します。**
    1. Azure portal で、検索バーを使用して「**Log Analytics ワークスペース**」と検索し、結果から選択します。
    2. ワークスペースの一覧で **[LogAnalytics1]** を選択します。
    3. LogAnalytics1 ワークスペースの左側のメニューで、**[ログ]** を選択します。
    4. モードのドロップダウンを使用して、**[簡易モード]** から **[KQL モード]** に変更します。
    5. クエリ ウィンドウに次のクエリを入力します。
        ```
        Heartbeat
        | where Computer contains "Linux-VM"
        | sort by TimeGenerated desc
        ```
    6. **[実行]** を選択するか、**Shift + Enter** キーを押してクエリを実行します。
    7. 結果が返された場合、データは流れ、Azure Monitor エージェントは動作しています。

### Log Analytics のデータ保持とアーカイブのポリシーを構成します。

1. Azure portal の検索バーに「**Log analytics**」と入力し、結果から **[Log Analytics ワークスペース]** を選択します。
2. **[Log Analytics ワークスペース]** ページで、**[LogAnalytics1]** を選択します。
3. LogAnalytics1 の **[Log Analytics ワークスペース]** ページの **[設定]** で **[使用量と推定コスト]** を選択します。
4. **[データ保持]** を選択し、スライダーを 60 日に設定します。 **[OK]** を選択します。
5. LogAnalytics1 の **[Log Analytics ワークスペース]** ページで、**[使用量と推定コスト]** を選択します。
6. **[日次上限]** を選択します。 **[ON]** を選択します。 日次上限を 10 GB に設定し、**[OK]** を選択します。

### Log Analytics ワークスペースへのアクセスを有効にします。

1. Azure portal の検索バーに「**Log analytics**」と入力し、結果から **[Log Analytics ワークスペース]** を選択します。
2. **[Log Analytics ワークスペース]** ページで、**[LogAnalytics1]** を選択します。
3. **[アクセス制御 (IAM)]** を選択します。
4. **[追加]**、次に **[ロールの割り当ての追加]** の順に選択します。
5. ロールの一覧で、**[Log Analytics 閲覧者]** を選択し、**[次へ]** を選択します。
6. **[メンバー]** ページで、**[メンバーの選択]** を選択し、[アプリ ログ調査官] セキュリティ グループを選択します。 **[選択] を選択します**。
7. **[メンバー]** ステップで、**[レビューと割り当て]** を選択します。
